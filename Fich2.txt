if not game: IsLoaded() then game. Loaded:Wait() end

repeat task.wait() until game:GetService("Players")
repeat task.wait() until game:GetService("Players").LocalPlayer
repeat task.wait() until game:GetService( "ReplicatedStorage")
repeat task.wait() until game:GetService( "ReplicatedFirst")
    local lgh =  game:GetService("Lighting")
    sethiddenproperty(lgh,"Technology",2)
    lgh.FogStart = 1/0
    lgh.FogEnd = 1/0

    for i,v in ipairs(lgh:GetChildren()) do
        if v:IsA("BloomEffect") or v:IsA("BlurEffect") or v:IsA("ColorCorrectionEffect") or v:IsA("SunRaysEffect") or v:IsA("DepthOfFieldEffect") then
            v.Enabled = false
        end
    end

    -- [Terrain]
    local wsc = game:GetService("Workspace")
    wsc.Terrain.CastShadow = false
    wsc.Terrain.WaterReflectance = 0
    wsc.Terrain.WaterWaveSize = 0
    wsc.Terrain.WaterTransparency = 0
    wsc.Terrain.WaterWaveSpeed = 0
    sethiddenproperty(wsc, 'StreamingTargetRadius', 64)
    sethiddenproperty(wsc, 'StreamingPauseMode', 2)
    sethiddenproperty(wsc.Terrain, 'Decoration', false)

    -- [Disabled]

    local boostmap = function(v)
        if v:IsA("Shirt") or v:IsA("Pants") then
            v[v.ClassName.."Template"] = ""
        elseif v:IsA("MeshPart") then
            v.TextureID = ""
        elseif v:IsA("BasePart") then
            v.Material = Enum.Material.SmoothPlastic
            v.Reflectance = 0
            v.CastShadow = false
        elseif v:IsA("SpecialMesh") then
            v.TextureId = 0 
        elseif v:IsA("Texture") or v:IsA("Decal") then
            v.Texture = ""
            v.Transparency = 1
        elseif v:IsA("ParticleEmitter") or v:IsA("Trail") then
            v.Enabled = false
            v.Lifetime = NumberRange.new(0)
        elseif v:IsA("Fire") or v:IsA("SpotLight") or v:IsA("Smoke") or v:IsA("Sparkles") or v:IsA("PostEffect") then
            v.Enabled = false
        elseif v:IsA("ShirtGraphic") then
            v.Graphic = ''
        elseif v:IsA("Model") then
            sethiddenproperty(v, 'LevelOfDetail', 1)
        end
    end
    for i,v in pairs(wsc:GetDescendants()) do
        pcall(boostmap,v)
    end
    wsc.DescendantAdded:Connect(function(v)
        pcall(boostmap,v)
    end)

    -- [Settings]
    --game:GetService("NetworkClient"):SetOutgoingKBPSLimit(100)
    settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
    settings().Rendering.MeshPartDetailLevel = Enum.MeshPartDetailLevel.Level01
    settings().Rendering.EagerBulkExecution = false

    settings().Network.IncomingReplicationLag = -1000
    settings().Physics.PhysicsEnvironmentalThrottle = 1

    UserSettings():GetService("UserGameSettings").MasterVolume = 0
    UserSettings():GetService("UserGameSettings").SavedQualityLevel = Enum.SavedQualitySetting.QualityLevel1
local lastEquipTime = 0
local equipCooldown = 1  -- cooldown time in seconds
local lastEquip2Time = 0
local equip2Cooldown = 1  -- cooldown time in seconds

local function AutoEquip()
    local currentTime = tick()
    if currentTime - lastEquipTime < equipCooldown then
        return  -- Skip if cooldown has not passed
    end

    local player = game.Players.LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local humanoid = character:FindFirstChildOfClass("Humanoid")

    if not humanoid then
        warn("Humanoid not found.")
        return
    end

    local playerStats = game:GetService("ReplicatedStorage"):FindFirstChild("playerstats")
    if not playerStats then
        warn("playerstats not found.")
        return
    end

    local rodsFolder = playerStats:FindFirstChild(player.Name)
    if not rodsFolder or not rodsFolder:FindFirstChild("Rods") then
        warn("Rods folder not found.")
        return
    end

    local backpack = player:FindFirstChild("Backpack")
    if backpack then
        for _, rod in ipairs(rodsFolder.Rods:GetChildren()) do
            local tool = backpack:FindFirstChild(rod.Name)
            if tool and not character:FindFirstChild(tool.Name) then
                humanoid:EquipTool(tool)
            end
        end
    end

    lastEquipTime = currentTime  -- Update the last equip time
end

local function AutoEquip2()
    local currentTime = tick()
    if currentTime - lastEquip2Time < equip2Cooldown then
        return  -- Skip if cooldown has not passed
    end

    local player = game.Players.LocalPlayer
    local playerStats = game:GetService("ReplicatedStorage"):FindFirstChild("playerstats")
    if not playerStats then
        warn("playerstats not found.")
        return
    end

    local rodsFolder = playerStats:FindFirstChild(player.Name) and playerStats[player.Name]:FindFirstChild("Rods")
    if not rodsFolder then return end

    local events = game:GetService("ReplicatedStorage"):WaitForChild("events")
    if rodsFolder:FindFirstChild("Carbon Rod") and not rodsFolder:FindFirstChild("Rapid Rod") then
        events:WaitForChild("equiprod"):FireServer("Carbon Rod")
    elseif rodsFolder:FindFirstChild("Rapid Rod") and not rodsFolder:FindFirstChild("Trident Rod") then
        events:WaitForChild("equiprod"):FireServer("Rapid Rod")
    end

    lastEquip2Time = currentTime  -- Update the last equip2 time
end

-- ฟังก์ชันคลิกปุ่ม UI
local function interact(path)
    if path then
        game:GetService("GuiService").SelectedObject = path
        task.wait(0.05)
        game:GetService("VirtualInputManager"):SendKeyEvent(true, Enum.KeyCode.Return, false, game)
        task.wait(0.05)
        game:GetService("VirtualInputManager"):SendKeyEvent(false, Enum.KeyCode.Return, false, game)
        task.wait(0.05)
        game:GetService("GuiService").SelectedObject = nil
    end
end

-- ฟังก์ชันตรวจสอบ UI "shakeui"
local function checkShakeUI(playerGui)
    return playerGui:FindFirstChild("shakeui") ~= nil
end

-- ฟังก์ชันสำหรับเช็คและยิงเหตุการณ์ Reel
local function fireReelEvent(times)
    -- ใช้การหน่วงเวลาเล็กน้อยเพื่อไม่ให้เกิดการเรียกที่รวดเร็วเกินไป
    for i = 1, times do
        task.delay(i * 0.1, function()  -- หน่วงเวลา 0.1 วินาทีแต่ละครั้ง
            game:GetService("ReplicatedStorage").events.reelfinished:FireServer(100, true)
        end)
    end
end

-- ฟังก์ชันสำหรับเช็คและยิงเหตุการณ์ Reel
local function checkAndFireReel(player)
    local playerGui = player.PlayerGui
    local reelGui = playerGui:FindFirstChild("reel")
    if reelGui then
        fireReelEvent(3)  -- เรียกใช้ฟังก์ชัน fireReelEvent เพื่อยิงเหตุการณ์
    end
end

-- ฟังก์ชันการเดินทาง
local function Teleport(target)
    local player = game.Players.LocalPlayer
    local humanoidRootPart = player.Character:WaitForChild("HumanoidRootPart")
    local distance = (target.Position - humanoidRootPart.Position).Magnitude
    local speed = distance > 1000 and 335 or 750  -- Adjust speed based on distance

    if distance < 10000 then
        humanoidRootPart.CFrame = CFrame.new(target.Position + Vector3.new(0, 0, 1), target.Position)
    else
        game:GetService("TweenService"):Create(humanoidRootPart, TweenInfo.new(distance / speed, Enum.EasingStyle.Linear), {CFrame = CFrame.new(target.Position + Vector3.new(0, 0, 1), target.Position)}):Play()
    end
end

-- ฟังก์ชันจัดการการเดินทาง
local function handleTeleportIfNecessary(coins, Carbon, player)
    local teleportLocation = CFrame.new(-1510.98096, -234.718964, -2869.49194)
    local playerStats = game:GetService("ReplicatedStorage").playerstats[player.Name]
    
    -- ใช้การเช็คสถานะต่างๆ ก่อนทำการ Teleport
    if coins <= 2000 and not Carbon then
        Teleport(teleportLocation)
    elseif coins >= 2000 and not Carbon then
        Autorobs()
        Reset()
    elseif coins >= 14000 and not playerStats.Rods:FindFirstChild("Rapid Rod") then
        Autorobs()
        Reset()
    elseif coins >= 150000 and not playerStats.Rods:FindFirstChild("Trident Rod") then
        Autorobs()
        Reset()
    elseif not checkShakeUI(player.PlayerGui) and Carbon and not playerStats.Rods:FindFirstChild("Trident Rod") then
        Teleport(teleportLocation)
    elseif not checkShakeUI(player.PlayerGui) and playerStats.Rods:FindFirstChild("Rapid Rod") and not playerStats.Rods:FindFirstChild("Trident Rod") then
        Teleport(teleportLocation)
    elseif not checkShakeUI(player.PlayerGui) and playerStats.Rods:FindFirstChild("Rapid Rod") and playerStats.Rods:FindFirstChild("Trident Rod") then
        Teleport(teleportLocation)
    end
end

-- ฟังก์ชันหลักที่ทำงานเมื่อ UI ไม่แสดง
game:GetService("RunService").Heartbeat:Connect(function()
    local success, errorMsg = pcall(function()
        local player = game.Players.LocalPlayer
        local playerGui = player:WaitForChild("PlayerGui")
        local playerStats = game:GetService("ReplicatedStorage").playerstats[player.Name]
        local coins = tonumber(playerStats.Stats.coins.Value)
        local rods = playerStats.Rods:GetChildren()
        local NPCs = workspace.world.npcs:GetChildren()
        local Carbon = playerStats.Rods:FindFirstChild("Carbon Rod")

        -- ตรวจสอบสถานะและทำงานการเดินทางและอัปเกรด rods
        pcall(function() handleTeleportIfNecessary(coins, Carbon, player) end)

        -- ส่งเหตุการณ์ cast ไปยังเซิร์ฟเวอร์ถ้า NPC คือ "Mel Merchant"
        for _, rod in pairs(rods) do
            if player.Character:FindFirstChild(rod.Name) then
                for _, NPC in pairs(NPCs) do
                    if NPC.Name == "Mel Merchant" then
                        local args = {100, 1}
                        pcall(function()
                            player.Character[rod.Name].events.cast:FireServer(unpack(args))
                        end)
                    end
                end
            end
        end

        -- คลิกปุ่ม "shakeui" ถ้ามี
        if checkShakeUI(playerGui) then
            local button = playerGui.shakeui.safezone.button
            if button then
                pcall(function() interact(button) end)
            end
        end

        -- ตรวจสอบการรีลและยิงเหตุการณ์ถ้าจำเป็น
        pcall(function() checkAndFireReel(player) end)

        -- ทำงาน AutoEquip2 และ AutoEquip
        pcall(function() AutoEquip() end)
        pcall(function() AutoEquip2() end)
    end)

    if not success then
        warn("Error occurred: " .. errorMsg)
    end
end)

while task.wait(1) do
    pcall(function()
        if game:GetService("Players").LocalPlayer.PlayerGui.loading.Enabled == true then
            if game.PlaceId == 16732694052 then
                if game:GetService("Players").LocalPlayer.PlayerGui.loading.loading:FindFirstChild("skip") then
                    interact1(game:GetService("Players").LocalPlayer.PlayerGui.loading.loading.skip)
                end
                if game:GetService("Players").LocalPlayer.PlayerGui.loading.Enabled == true then
                    game:GetService("VirtualInputManager"):SendMouseButtonEvent(10, 100, 0, true, nil, 1)
                    game:GetService("VirtualInputManager"):SendMouseButtonEvent(10, 100, 0, false, nil, 1)
                    return
                end
                local playerStats = game:GetService("ReplicatedStorage"):WaitForChild("playerstats"):WaitForChild(playerName)
                if playerStats and playerStats.Settings.showflags then
                    local showFlags = playerStats.Settings.showflags
                    if showFlags.Value == true then
                        showFlags.Value = false
                    end
                end
            end
        end
    end)
end
