if not game: IsLoaded() then game. Loaded:Wait() end

repeat task.wait() until game:GetService("Players")
repeat task.wait() until game:GetService("Players").LocalPlayer
repeat task.wait() until game:GetService( "ReplicatedStorage")
repeat task.wait() until game:GetService( "ReplicatedFirst")
    local lgh =  game:GetService("Lighting")
    sethiddenproperty(lgh,"Technology",2)
    lgh.FogStart = 1/0
    lgh.FogEnd = 1/0

    for i,v in ipairs(lgh:GetChildren()) do
        if v:IsA("BloomEffect") or v:IsA("BlurEffect") or v:IsA("ColorCorrectionEffect") or v:IsA("SunRaysEffect") or v:IsA("DepthOfFieldEffect") then
            v.Enabled = false
        end
    end

    -- [Terrain]
    local wsc = game:GetService("Workspace")
    wsc.Terrain.CastShadow = false
    wsc.Terrain.WaterReflectance = 0
    wsc.Terrain.WaterWaveSize = 0
    wsc.Terrain.WaterTransparency = 0
    wsc.Terrain.WaterWaveSpeed = 0
    sethiddenproperty(wsc, 'StreamingTargetRadius', 64)
    sethiddenproperty(wsc, 'StreamingPauseMode', 2)
    sethiddenproperty(wsc.Terrain, 'Decoration', false)

    -- [Disabled]

    local boostmap = function(v)
        if v:IsA("Shirt") or v:IsA("Pants") then
            v[v.ClassName.."Template"] = ""
        elseif v:IsA("MeshPart") then
            v.TextureID = ""
        elseif v:IsA("BasePart") then
            v.Material = Enum.Material.SmoothPlastic
            v.Reflectance = 0
            v.CastShadow = false
        elseif v:IsA("SpecialMesh") then
            v.TextureId = 0 
        elseif v:IsA("Texture") or v:IsA("Decal") then
            v.Texture = ""
            v.Transparency = 1
        elseif v:IsA("ParticleEmitter") or v:IsA("Trail") then
            v.Enabled = false
            v.Lifetime = NumberRange.new(0)
        elseif v:IsA("Fire") or v:IsA("SpotLight") or v:IsA("Smoke") or v:IsA("Sparkles") or v:IsA("PostEffect") then
            v.Enabled = false
        elseif v:IsA("ShirtGraphic") then
            v.Graphic = ''
        elseif v:IsA("Model") then
            sethiddenproperty(v, 'LevelOfDetail', 1)
        end
    end
    for i,v in pairs(wsc:GetDescendants()) do
        pcall(boostmap,v)
    end
    wsc.DescendantAdded:Connect(function(v)
        pcall(boostmap,v)
    end)

    -- [Settings]
    --game:GetService("NetworkClient"):SetOutgoingKBPSLimit(100)
    settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
    settings().Rendering.MeshPartDetailLevel = Enum.MeshPartDetailLevel.Level01
    settings().Rendering.EagerBulkExecution = false

    settings().Network.IncomingReplicationLag = -1000
    settings().Physics.PhysicsEnvironmentalThrottle = 1

    UserSettings():GetService("UserGameSettings").MasterVolume = 0
    UserSettings():GetService("UserGameSettings").SavedQualityLevel = Enum.SavedQualitySetting.QualityLevel1
-- ฟังก์ชัน AutoEquip สำหรับการติดตั้ง Rod อัตโนมัติ
local function AutoEquip()
    local player = game.Players.LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local humanoid = character:FindFirstChildOfClass("Humanoid")

    if not humanoid then
        warn("Humanoid not found in character.")
        return
    end

    local playerStats = game:GetService("ReplicatedStorage"):FindFirstChild("playerstats")
    if not playerStats then
        warn("playerstats folder not found in ReplicatedStorage.")
        return
    end

    local rodsFolder = playerStats:FindFirstChild(player.Name)
    if not rodsFolder or not rodsFolder:FindFirstChild("Rods") then
        warn("Rods folder not found for the player in ReplicatedStorage.")
        return
    end

    local RunService = game:GetService("RunService")
    RunService.Heartbeat:Connect(function()
        pcall(function()
            local backpack = player:FindFirstChild("Backpack")
            if backpack then
                for _, rod in ipairs(rodsFolder.Rods:GetChildren()) do
                    local tool = backpack:FindFirstChild(rod.Name)
                    if tool and not character:FindFirstChild(tool.Name) then
                        humanoid:EquipTool(tool)
                    end
                end
            else
                warn("Backpack not found for the player.")
            end
        end)
    end)
end


local function AutoEquip2()
    local player = game:GetService("Players").LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local playerStats = game:GetService("ReplicatedStorage"):FindFirstChild("playerstats")

    if not playerStats then
        warn("playerstats not found in ReplicatedStorage.")
        return
    end

    local rodsFolder = playerStats:FindFirstChild(player.Name) and playerStats[player.Name]:FindFirstChild("Rods")
    if not rodsFolder then return end

    for _, rod in ipairs(rodsFolder:GetChildren()) do
        local events = game:GetService("ReplicatedStorage"):WaitForChild("events")
        if rodsFolder:FindFirstChild("Carbon Rod") and not rodsFolder:FindFirstChild("Nocturnal Rod") then
            events:WaitForChild("equiprod"):FireServer("Carbon Rod")
        elseif rodsFolder:FindFirstChild("Nocturnal Rod") and not rodsFolder:FindFirstChild("Trident Rod") then
            events:WaitForChild("equiprod"):FireServer("Nocturnal Rod")
        elseif rod.Name == "Trident Rod" then
            events:WaitForChild("equiprod"):FireServer("Trident Rod")
        end
    end
end


local function interact1(path)
    if path then
        game:GetService("GuiService").SelectedObject = path
        task.wait(0.1)
        game:GetService("VirtualInputManager"):SendKeyEvent(true, Enum.KeyCode.Return, false, game)
        task.wait(0.1)
        game:GetService("VirtualInputManager"):SendKeyEvent(false, Enum.KeyCode.Return, false, game)
        task.wait(0.1)
        game:GetService("GuiService").SelectedObject = nil
    end
end

local function Autorobs()
    local player = game.Players.LocalPlayer
    local playerName = player.Name
    local coins = tonumber(game:GetService("ReplicatedStorage").playerstats[playerName].Stats.coins.Value)
    local hasCarbonRod, hasNocturnalRod = false, false

    for _, rod in pairs(game:GetService("ReplicatedStorage").playerstats[playerName].Rods:GetChildren()) do
        if rod.Name == "Carbon Rod" then
            hasCarbonRod = true
        elseif rod.Name == "Nocturnal Rod" then
            hasNocturnalRod = true
        elseif rod.Name == "Trident Rod" then
            hasTridentRod = true
        end
    end

    if not hasCarbonRod and coins >= 2000 then
        local prompt = player.PlayerGui:FindFirstChild("over") and player.PlayerGui.over:FindFirstChild("prompt")
        if prompt then
            interact1(prompt.confirm)
        else
            player.Character.HumanoidRootPart.CFrame = CFrame.new(449, 151, 226)
            fireproximityprompt(workspace.world.interactables["Carbon Rod"].purchaserompt)
            interact1(prompt.confirm)
        end
    end
    if not hasNocturnalRod and coins >= 12000 then
        local prompt = player.PlayerGui:FindFirstChild("over") and player.PlayerGui.over:FindFirstChild("prompt")
        if prompt then
            interact1(prompt.confirm)
        else
            player.Character.HumanoidRootPart.CFrame = CFrame.new(-144, -515, 1142)
            fireproximityprompt(workspace.world.interactables["Nocturnal Rod"].purchaserompt)
            interact1(prompt.confirm)
        end
    end
    if not hasTridentRod and coins >= 150000 then
        local prompt = player.PlayerGui:FindFirstChild("over") and player.PlayerGui.over:FindFirstChild("prompt")
        if prompt then
            interact1(prompt.confirm)
            player.Character.HumanoidRootPart.CFrame = CFrame.new(-1484, -226, -2200)
        else
            player.Character.HumanoidRootPart.CFrame = CFrame.new(-1484, -226, -2200)
            fireproximityprompt(workspace.world.interactables["Trident Rod"].purchaserompt)
            interact1(prompt.confirm)
        end
    end
end

local function Sell()
    local backpack = game.Players.LocalPlayer.Backpack
    wait(600) -- รอ 600 วินาที

    -- เปลี่ยนตำแหน่งของ HumanoidRootPart
    game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(-1656, -214, -2825)

    -- ตรวจสอบว่า Mel Merchant และฟังก์ชัน sellall มีอยู่จริงหรือไม่
    local melMerchant = workspace.world.npcs:FindFirstChild("Mel Merchant")
    if melMerchant and melMerchant.merchant and melMerchant.merchant.sellall then
        melMerchant.merchant.sellall:InvokeServer() -- เรียกใช้ sellall
    else
        warn("ไม่พบ Mel Merchant หรือฟังก์ชัน sellall")
    end
end


local function Reset()
    local player = game:GetService("Players").LocalPlayer
    local playerName = player.Name
    local playerGui = player.PlayerGui
    local rods = game:GetService("ReplicatedStorage").playerstats[playerName].Rods:GetChildren()
    local rodsInWorld = workspace[playerName]:GetChildren()  -- เปลี่ยนชื่อเป็น rodsInWorld
    local character = player.Character

    for _, rod in pairs(rods) do
        for _, rodInWorld in pairs(rodsInWorld) do
            -- ตรวจสอบว่า bobber มีอยู่และไม่มี shakeui
            if rodInWorld:FindFirstChild("bobber") and not playerGui:FindFirstChild("shakeui") then
                wait(300)
                local rodTool = character:FindFirstChild(rod.Name)
                if rodTool then  -- ตรวจสอบว่า rod อยู่ในตัวละครก่อน
                    rodTool.events.reset:FireServer()
                end
            end
        end
    end
end

-- ฟังก์ชัน Teleport
function Teleport(target)
    local player = game.Players.LocalPlayer
    local humanoidRootPart = player.Character:WaitForChild("HumanoidRootPart") -- เพิ่มการรอ HumanoidRootPart
    local distance = (target.Position - humanoidRootPart.Position).Magnitude
    local speed

    -- กำหนดความเร็วตามระยะทาง
    if distance > 1000 then
        speed = 335
    elseif distance > 500 then
        speed = 335
    elseif distance > 285 then
        speed = 750
    else
        speed = 335
    end

    -- เคลื่อนที่ผู้เล่น
    if distance < 10000 then
        if _G.Tween then
            _G.Tween:Cancel()
        end
        humanoidRootPart.CFrame = CFrame.new(target.Position + Vector3.new(0, 0, 1), target.Position)
    elseif distance > 285 then
        if _G.Tween then
            _G.Tween:Cancel() -- ยกเลิก Tween ก่อนสร้างใหม่
        end
        _G.Tween = game:GetService("TweenService"):Create(
            humanoidRootPart, 
            TweenInfo.new(distance / speed, Enum.EasingStyle.Linear), 
            {CFrame = CFrame.new(target.Position + Vector3.new(0, 0, 1), target.Position)}
        )
        _G.Tween:Play()
    end
end

spawn(function()
    _G.Kuy = true
    local NoclipNotDup = tostring(math.random(10000000, 99999999))
    local fenv = getgenv()
    local shp = fenv.sethiddenproperty or fenv.set_hidden_property or fenv.set_hidden_prop or fenv.sethiddenprop
    local localplayer = game.Players.LocalPlayer
    
    while game:GetService("RunService").Stepped:Wait() do
        wait(0.1)  -- เพิ่ม wait เพื่อชะลอการทำงานของลูป
        
        pcall(function()
            if not localplayer.Character or not localplayer.Character:FindFirstChild("Humanoid") then return end
            
            local Humanoid = localplayer.Character.Humanoid
            local Root = localplayer.Character:FindFirstChild("HumanoidRootPart")

            if not Root then return end  -- ตรวจสอบว่า Root มีอยู่

            if shp then
                shp(localplayer, "SimulationRadius", 3300)
            end
            
            if _G.Kuy then
                if Humanoid:GetState() == Enum.HumanoidStateType.Seated or Humanoid.Health <= 0 then 
                    Humanoid.Jump = true
                    Humanoid.Sit = false
                    if Root:FindFirstChild("NoClip" .. NoclipNotDup) then 
                        Root:FindFirstChild("NoClip" .. NoclipNotDup):Destroy()
                    end
                end

                if Humanoid.Sit == false and Humanoid.Health > 0 then
                    for _, v in pairs(localplayer.Character:GetChildren()) do
                        if v:IsA("BasePart") then
                            v.CanCollide = false
                        end
                    end
                else
                    Humanoid.Sit = false
                end
                
                if not Root:FindFirstChild("NoClip" .. NoclipNotDup) and Humanoid.Sit == false then
                    local bv = Instance.new("BodyVelocity")
                    bv.Parent = Root
                    bv.Name = "NoClip" .. NoclipNotDup
                    bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
                    bv.Velocity = Vector3.new(0, 0, 0)  -- ปรับให้เหมาะสม
                end
            else
                if Root:FindFirstChild("NoClip" .. NoclipNotDup) then 
                    Root:FindFirstChild("NoClip" .. NoclipNotDup):Destroy()
                end
            end
        end)
    end
end)
-- ฟังก์ชันสำหรับคลิกปุ่ม GUI
local function interact(path)
    if path then
        game:GetService("GuiService").SelectedObject = path
        task.wait(0.05)
        game:GetService("VirtualInputManager"):SendKeyEvent(true, Enum.KeyCode.Return, false, game)
        task.wait(0.05)
        game:GetService("VirtualInputManager"):SendKeyEvent(false, Enum.KeyCode.Return, false, game)
        task.wait(0.05)
        game:GetService("GuiService").SelectedObject = nil
    end
end

-- เริ่มการทำงานในกระบวนการใหม่
spawn(function()
    local Players = game:GetService("Players")
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local player = Players.LocalPlayer
    local playerGui = player:WaitForChild("PlayerGui")

    while task.wait(0.1) do
        pcall(function()
            if game:GetService("Players").LocalPlayer.PlayerGui.loading.Enabled == false then
                local character = player.Character or player.CharacterAdded:Wait()
                local playerName = player.Name
                local coins = tonumber(ReplicatedStorage.playerstats[playerName].Stats.coins.Value)
                local playerStats = ReplicatedStorage.playerstats[playerName]
                local rods = playerStats.Rods:GetChildren()
                local NPCs = workspace.world.npcs:GetChildren()
                local Carbon = game:GetService("ReplicatedStorage").playerstats[playerName].Rods:FindFirstChild("Carbon Rod")

                -- เช็คเงื่อนไขต่างๆ
                local isShakeUI = playerGui:FindFirstChild("shakeui") ~= nil

                for _, rod in pairs(rods) do
                    if not isShakeUI and coins <= 2000 and not Carbon then
                        -- โทรฟังก์ชัน Teleport
                        Teleport(CFrame.new(-1510.98096, -234.718964, -2869.49194))
                    elseif coins >= 2000 and not Carbon then
                        Autorobs()
                        if _G.Tween then
                            _G.Tween:Cancel()
                        end
                    elseif coins >= 12000 and not playerStats.Rods:FindFirstChild("Nocturnal Rod") then
                        Autorobs()
                        if _G.Tween then
                            _G.Tween:Cancel()
                        end
                    elseif coins >= 150000 and not playerStats.Rods:FindFirstChild("Trident Rod") then
                        Autorobs()
                        if _G.Tween then
                            _G.Tween:Cancel()
                        end
                    elseif not isShakeUI and Carbon and not playerStats.Rods:FindFirstChild("Trident Rod") then
                        Teleport(CFrame.new(-1510.98096, -234.718964, -2869.49194))
                    elseif not isShakeUI and playerStats.Rods:FindFirstChild("Nocturnal Rod") and not playerStats.Rods:FindFirstChild("Trident Rod") then
                        Teleport(CFrame.new(-1510.98096, -234.718964, -2869.49194))
                    elseif not isShakeUI and playerStats.Rods:FindFirstChild("Nocturnal Rod") and playerStats.Rods:FindFirstChild("Trident Rod") then
                        Teleport(CFrame.new(-1510.98096, -234.718964, -2869.49194))
                    end

                    -- ส่งเหตุการณ์ cast ไปยังเซิร์ฟเวอร์ถ้า NPC คือ "Mel Merchant"
                    for _, NPC in pairs(NPCs) do
                        if NPC.Name == "Mel Merchant" and character:FindFirstChild(rod.Name) then
                            local args = {100, 1}
                            character[rod.Name].events.cast:FireServer(unpack(args))
                        end
                    end
                end
                -- คลิกปุ่ม "shakeui" ถ้ามี
                if isShakeUI then
                    local button = playerGui.shakeui.safezone.button
                    if button then
                        interact(button)
                    end
                end

                -- if playerGui:FindFirstChild("reel") then
                --     for _ = 1, 35 do
                --         task.defer(function()
                --             ReplicatedStorage.events.reelfinished:FireServer(100, true)
                --         end)
                --     end
                -- end
                if not isShakeUI then
                    AutoEquip()
                    wait(0.5)
                end
                AutoEquip2()
            end
        end)
    end
end)

spawn(function()
    local Players = game:GetService("Players")
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local player = Players.LocalPlayer
    local playerGui = player:WaitForChild("PlayerGui")

    while task.wait(0.1) do
        local success, errorMessage = pcall(function()
            local reelGui = playerGui:FindFirstChild("reel")
            if reelGui then
                -- ใช้ task.spawn เพื่อให้คำสั่ง FireServer รันได้อย่างรวดเร็วและปลอดภัย
                for _ = 1, 35 do
                    task.spawn(function()
                        ReplicatedStorage.events.reelfinished:FireServer(100, true)
                    end)
                end
            end
        end)

        if not success then
            warn("Error occurred: " .. errorMessage)
        end
    end
end)



while task.wait(0.1) do
    pcall(function()
        if game:GetService("Players").LocalPlayer.PlayerGui.loading.Enabled == false then
            Sell()
            --AutoEquip2()
            Autorobs()
            Reset()
        elseif game:GetService("Players").LocalPlayer.PlayerGui.loading.Enabled == true then
            if game.PlaceId == 16732694052 then
                if game:GetService("Players").LocalPlayer.PlayerGui.loading.loading:FindFirstChild("skip") then
                    interact1(game:GetService("Players").LocalPlayer.PlayerGui.loading.loading.skip)
                end
                if game:GetService("Players").LocalPlayer.PlayerGui.loading.Enabled == true then
                    game:GetService("VirtualInputManager"):SendMouseButtonEvent(10, 100, 0, true, nil, 1)
                    game:GetService("VirtualInputManager"):SendMouseButtonEvent(10, 100, 0, false, nil, 1)
                    return
                end
                if game.Workspace:FindFirstChild("active") and game.Workspace.active:FindFirstChild("flags") then
                    game.Workspace.active.flags:Destroy()
                    return
                end
            end
        end
    end)
end
