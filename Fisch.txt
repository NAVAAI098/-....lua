local function createGui()
    local playerGui = game.Players.LocalPlayer:WaitForChild("PlayerGui")
    local existingGui = playerGui:FindFirstChild("kaitun - budget")
    
    if existingGui then
        existingGui:Destroy()
    end
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "kaitun - budget"
    ScreenGui.Parent = playerGui
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    ScreenGui.DisplayOrder = 999
    ScreenGui.ResetOnSpawn = false
    ScreenGui.IgnoreGuiInset = true
    local Frame = Instance.new("Frame")
    Frame.Parent = ScreenGui
    Frame.Active = false
    Frame.AnchorPoint = Vector2.new(0.5, 0.5)
    Frame.BackgroundColor3 = Color3.fromRGB(7, 7, 7)
    Frame.BackgroundTransparency = 0.5
    Frame.Position = UDim2.new(0.5, 0, 0.5, 0)
    Frame.Size = UDim2.new(1, 0, 1, 0)
    local TextLabel = Instance.new("TextLabel")
    TextLabel.Parent = Frame
    TextLabel.Active = true
    TextLabel.BackgroundTransparency = 1
    TextLabel.Position = UDim2.new(0.52, 0, 0.32, 0)
    TextLabel.Size = UDim2.new(0.38, 0, 0.36, 0)
    TextLabel.Font = Enum.Font.FredokaOne
    TextLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    TextLabel.TextScaled = true
    TextLabel.Text = "By.ตัง56:ใช้แล้วได้ดี "
    TextLabel.TextWrapped = true
    TextLabel.TextXAlignment = Enum.TextXAlignment.Left
end

createGui()

-- ฟังก์ชันสำหรับการสวมใส่เครื่องมืออัตโนมัติ
local function AutoEquip()
    local player = game.Players.LocalPlayer
    local playerName = player.Name
    local character = player.Character or player.CharacterAdded:Wait()

    -- ตรวจสอบว่า Humanoid มีอยู่ในตัวละคร
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then
        warn("Humanoid not found in character.")
        return
    end

    -- ตรวจสอบว่าโฟลเดอร์ Rods มีอยู่ใน ReplicatedStorage
    local rodsFolder = game:GetService("ReplicatedStorage").playerstats:FindFirstChild(playerName)
    if not rodsFolder or not rodsFolder:FindFirstChild("Rods") then
        warn("Rods folder not found for the player in ReplicatedStorage.")
        return
    end

    -- วนลูปเพื่อตรวจสอบการสวมใส่เครื่องมืออัตโนมัติ
    spawn(function()
        while task.wait(0.5) do -- ตรวจสอบทุก ๆ 0.5 วินาที (สามารถปรับค่าได้)
            pcall(function()
                -- ตรวจสอบ Backpack ของผู้เล่น
                local backpack = player:FindFirstChild("Backpack")
                if backpack then
                    for _, rod in pairs(rodsFolder.Rods:GetChildren()) do
                        local tool = backpack:FindFirstChild(rod.Name)
                        if tool and not humanoid:FindFirstChild(tool.Name) then
                            -- สวมใส่เครื่องมือถ้าหากยังไม่ได้ติดตั้ง
                            humanoid:EquipTool(tool)
                        end
                    end
                else
                    warn("Backpack not found for the player.")
                    return
                end
            end)
        end
    end)
end


local function AutoEquip2()
    local player = game:GetService("Players").LocalPlayer
    local character = player.Character or player.CharacterAdded:Wait()
    local playerName = player.Name

    -- ตรวจสอบว่ามี Rods ใน playerstats
    local rodsFolder = game:GetService("ReplicatedStorage").playerstats:FindFirstChild(playerName) and game:GetService("ReplicatedStorage").playerstats[playerName]:FindFirstChild("Rods")
    
    if rodsFolder then
        for _, rod in pairs(rodsFolder:GetChildren()) do
            -- ตรวจสอบว่า rod เป็น Carbon Rod และไม่มี Nocturnal Rod
            if game:GetService("ReplicatedStorage").playerstats[playerName].Rods:FindFirstChild("Carbon Rod") and not game:GetService("ReplicatedStorage").playerstats[playerName].Rods:FindFirstChild("Nocturnal Rod") then
                local args = { [1] = "Carbon Rod" }
                game:GetService("ReplicatedStorage"):WaitForChild("events"):WaitForChild("equiprod"):FireServer(unpack(args))
            elseif game:GetService("ReplicatedStorage").playerstats[playerName].Rods:FindFirstChild("Carbon Rod") and game:GetService("ReplicatedStorage").playerstats[playerName].Rods:FindFirstChild("Nocturnal Rod") and not game:GetService("ReplicatedStorage").playerstats[playerName].Rods:FindFirstChild("Trident Rod") then
                local args = { [1] = "Nocturnal Rod" }
                game:GetService("ReplicatedStorage"):WaitForChild("events"):WaitForChild("equiprod"):FireServer(unpack(args))
            elseif rod:IsA("Instance") and rod.Name == "Trident Rod" and game:GetService("ReplicatedStorage").playerstats[playerName].Rods:FindFirstChild("Trident Rod") then
                local args = { [1] = "Trident Rod" }
                game:GetService("ReplicatedStorage"):WaitForChild("events"):WaitForChild("equiprod"):FireServer(unpack(args))
            end
        end
    end
end

local function interact1(path)
    if path then
        game:GetService("GuiService").SelectedObject = path
        task.wait(0.1)
        game:GetService("VirtualInputManager"):SendKeyEvent(true, Enum.KeyCode.Return, false, game)
        task.wait(0.1)
        game:GetService("VirtualInputManager"):SendKeyEvent(false, Enum.KeyCode.Return, false, game)
        task.wait(0.1)
        game:GetService("GuiService").SelectedObject = nil
    end
end

--ฟังก์ชันสำหรับการ AutoRob
local function Autorobs()
    local player = game.Players.LocalPlayer
    local playerName = player.Name
    local coins = tonumber(game:GetService("ReplicatedStorage").playerstats[playerName].Stats.coins.Value)
    local hasCarbonRod, hasNocturnalRod = false, false

    for _, rod in pairs(game:GetService("ReplicatedStorage").playerstats[playerName].Rods:GetChildren()) do
        if rod.Name == "Carbon Rod" then
            hasCarbonRod = true
        elseif rod.Name == "Nocturnal Rod" then
            hasNocturnalRod = true
        elseif rod.Name == "Trident Rod" then
            hasTridentRod = true
        end
    end

    if not hasCarbonRod and coins >= 2000 then
        local prompt = player.PlayerGui:FindFirstChild("over") and player.PlayerGui.over:FindFirstChild("prompt")
        if prompt then
            interact1(prompt.confirm)
            fireproximityprompt(workspace.world.interactables["Carbon Rod"].purchaserompt)
            game:GetService("Players").LocalPlayer.Character:FindFirstChild("Flimsy Rod").events.reset:FireServer()
            game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(454, 153, 223)
        else
            game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(454, 153, 223)
            fireproximityprompt(workspace.world.interactables["Carbon Rod"].purchaserompt)
            game:GetService("Players").LocalPlayer.Character:FindFirstChild("Flimsy Rod").events.reset:FireServer()
        end
    end
    if not hasNocturnalRod and coins >= 12000 then
        local prompt = player.PlayerGui:FindFirstChild("over") and player.PlayerGui.over:FindFirstChild("prompt")
        if prompt then
            interact1(prompt.confirm)
            fireproximityprompt(workspace.world.interactables["Nocturnal Rod"].purchaserompt)
            game:GetService("Players").LocalPlayer.Character:FindFirstChild("Carbon Rod").events.reset:FireServer()
            game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(-144, -515, 1142)
        else
            game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(-144, -515, 1142)
            fireproximityprompt(workspace.world.interactables["Nocturnal Rod"].purchaserompt)
            game:GetService("Players").LocalPlayer.Character:FindFirstChild("Carbon Rod").events.reset:FireServer()
        end
    end
    if not hasTridentRod and coins >= 150000 then
        local prompt = player.PlayerGui:FindFirstChild("over") and player.PlayerGui.over:FindFirstChild("prompt")
        if prompt then
            interact1(prompt.confirm)
            fireproximityprompt(workspace.world.interactables["Trident Rod"].purchaserompt)
            game:GetService("Players").LocalPlayer.Character:FindFirstChild("Nocturnal Rod").events.reset:FireServer()
            game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(-144, -515, 1142)
        else
            game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(-1484, -223, -2195)
            fireproximityprompt(workspace.world.interactables["Trident Rod"].purchaserompt)
            game:GetService("Players").LocalPlayer.Character:FindFirstChild("Nocturnal Rod").events.reset:FireServer()
        end
    end
end

local function Sell()
    local backpack = game:GetService("Players").LocalPlayer.Backpack
    local itemCount = #backpack:GetChildren()  -- นับจำนวนรายการใน Backpack
    if itemCount > 50 then
        game:GetService("Players").LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(-1656, -214, -2825)
        workspace:WaitForChild("world"):WaitForChild("npcs"):WaitForChild("Mel Merchant"):WaitForChild("merchant"):WaitForChild("sellall"):InvokeServer()
    end
end

local function Reset()
    local player = game:GetService("Players").LocalPlayer
    local playerName = player.Name
    local playerGui = player.PlayerGui
    local rods = game:GetService("ReplicatedStorage").playerstats[playerName].Rods:GetChildren()
    local rodsInWorld = workspace[playerName]:GetChildren()  -- เปลี่ยนชื่อเป็น rodsInWorld
    local character = player.Character

    for _, rod in pairs(rods) do
        for _, rodInWorld in pairs(rodsInWorld) do
            -- ตรวจสอบว่า bobber มีอยู่และไม่มี shakeui
            if rodInWorld:FindFirstChild("bobber") and not playerGui:FindFirstChild("shakeui") then
                wait(100)
                local rodTool = character:FindFirstChild(rod.Name)
                if rodTool then  -- ตรวจสอบว่า rod อยู่ในตัวละครก่อน
                    rodTool.events.reset:FireServer()
                end
            end
        end
    end
end

-- ฟังก์ชัน Teleport
function Teleport(target)
    local player = game.Players.LocalPlayer
    local humanoidRootPart = player.Character:WaitForChild("HumanoidRootPart") -- เพิ่มการรอ HumanoidRootPart
    local distance = (target.Position - humanoidRootPart.Position).Magnitude
    local speed

    -- กำหนดความเร็วตามระยะทาง
    if distance > 1000 then
        speed = 335
    elseif distance > 500 then
        speed = 335
    elseif distance > 285 then
        speed = 750
    else
        speed = 335
    end

    -- เคลื่อนที่ผู้เล่น
    if distance < 10000 then
        if _G.Tween then
            _G.Tween:Cancel()
        end
        humanoidRootPart.CFrame = CFrame.new(target.Position + Vector3.new(0, 0, 1), target.Position)
    elseif distance > 285 then
        if _G.Tween then
            _G.Tween:Cancel() -- ยกเลิก Tween ก่อนสร้างใหม่
        end
        _G.Tween = game:GetService("TweenService"):Create(
            humanoidRootPart, 
            TweenInfo.new(distance / speed, Enum.EasingStyle.Linear), 
            {CFrame = CFrame.new(target.Position + Vector3.new(0, 0, 1), target.Position)}
        )
        _G.Tween:Play()
    end
end

spawn(function()
    _G.Kuy = true
    local NoclipNotDup = tostring(math.random(10000000,99999999))
    local fenv = getgenv()
    local shp = fenv.sethiddenproperty or fenv.set_hidden_property or fenv.set_hidden_prop or fenv.sethiddenprop
    local localplayer  = game.Players.LocalPlayer
    while game:GetService("RunService").Stepped:Wait() do
        pcall(function()
            local Humanoid = localplayer.Character.Humanoid
            local Root = localplayer.Character.HumanoidRootPart
            if shp then
                shp(localplayer, "SimulationRadius", 3300)
            end
            if _G.Kuy then
                
                if Humanoid:GetState() == Enum.HumanoidStateType.Seated or Humanoid.Health <= 0 then 
                    Humanoid.Jump = true
                    Humanoid.Sit = false
                    if Root:FindFirstChild("NoClip"..NoclipNotDup) then 
                        Root:FindFirstChild("NoClip"..NoclipNotDup):Destroy()
                    end
                end

                if Humanoid.Sit == false and Humanoid.Health > 0 then
                    for i,v in pairs(localplayer.Character:GetChildren()) do
                        if v:IsA("BasePart") then
                            v.CanCollide = false
                        end
                    end
                else
                    Humanoid.Sit = false
                end
                if not Root:FindFirstChild("NoClip"..NoclipNotDup) and Humanoid.Sit == false then

                    local bv = Instance.new("BodyVelocity")
                    bv.Parent = Root
                    bv.Name = "NoClip"..NoclipNotDup
                    bv.MaxForce = Vector3.new(math.huge,math.huge,math.huge)
                    bv.Velocity = Vector3.new(0,0,0)
                end
            else
                if Root:FindFirstChild("NoClip"..NoclipNotDup) then 
                    Root:FindFirstChild("NoClip"..NoclipNotDup):Destroy()
                end
            end
        end)
    end
end)



local function interact(path)
    if path then
        game:GetService("GuiService").SelectedObject = path
        task.wait(0.05)
        game:GetService("VirtualInputManager"):SendKeyEvent(true, Enum.KeyCode.Return, false, game)
        task.wait(0.05)
        game:GetService("VirtualInputManager"):SendKeyEvent(false, Enum.KeyCode.Return, false, game)
        task.wait(0.05)
        game:GetService("GuiService").SelectedObject = nil
    end
end
-- เริ่มการทำงานในกระบวนการใหม่
-- ฟังก์ชันสำหรับการตรวจสอบเงื่อนไขและจัดการกิจกรรมในเกม
function ManagePlayerActions()
    local Players = game:GetService("Players")
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local player = Players.LocalPlayer
    local playerGui = player:WaitForChild("PlayerGui")

    spawn(function()
        while task.wait(0.1) do
            pcall(function()
                local character = player.Character or player.CharacterAdded:Wait()
                local playerName = player.Name
                local coins = tonumber(ReplicatedStorage.playerstats[playerName].Stats.coins.Value)
                local playerStats = ReplicatedStorage.playerstats[playerName]
                local NPCs = workspace.world.npcs:GetChildren()
                local rods = playerStats.Rods:GetChildren()

                local isShakeUI = playerGui:FindFirstChild("shakeui") ~= nil

                for _, rod in pairs(rods) do
                    if not isShakeUI and coins <= 2000 and not playerStats.Rods:FindFirstChild("Carbon Rod") then
                        -- โทรฟังก์ชัน Teleport
                        Teleport(CFrame.new(-1510.98096, -234.718964, -2869.49194))
                    elseif coins >= 2000 and not playerStats.Rods:FindFirstChild("Carbon Rod") then
                        if _G.Tween then
                            _G.Tween:Cancel()
                        end
                    elseif coins >= 12000 and not playerStats.Rods:FindFirstChild("Nocturnal Rod") then
                        if _G.Tween then
                            _G.Tween:Cancel()
                        end
                    elseif coins >= 150000 and not playerStats.Rods:FindFirstChild("Trident Rod") then
                        if _G.Tween then
                            _G.Tween:Cancel()
                        end
                    elseif not isShakeUI and playerStats.Rods:FindFirstChild("Carbon Rod") and not playerStats.Rods:FindFirstChild("Trident Rod") then
                        Teleport(CFrame.new(-1510.98096, -234.718964, -2869.49194))
                    elseif not isShakeUI and playerStats.Rods:FindFirstChild("Nocturnal Rod") and not playerStats.Rods:FindFirstChild("Trident Rod") then
                        Teleport(CFrame.new(-1510.98096, -234.718964, -2869.49194))
                    elseif not isShakeUI and playerStats.Rods:FindFirstChild("Nocturnal Rod") and playerStats.Rods:FindFirstChild("Trident Rod") then
                        Teleport(CFrame.new(-1510.98096, -234.718964, -2869.49194))
                    end

                    -- ส่งเหตุการณ์ cast ไปยังเซิร์ฟเวอร์ถ้า NPC คือ "Mel Merchant"
                    for _, NPC in pairs(NPCs) do
                        if NPC.Name == "Mel Merchant" and character:FindFirstChild(rod.Name) and not isShakeUI then
                            local args = {100, 1}
                            character[rod.Name].events.cast:FireServer(unpack(args))
                        end
                    end

                    -- คลิกปุ่ม "shakeui" ถ้ามี
                    if isShakeUI then
                        local button = playerGui.shakeui.safezone.button
                        if button then
                            interact(button)
                        end
                    end

                    -- ส่งเหตุการณ์ "reelfinished" ถ้ามี "reel"
                    if playerGui:FindFirstChild("reel") then
                        local args = {100, false}
                        local eventsFolder = ReplicatedStorage:WaitForChild("events")
                        eventsFolder:WaitForChild("reelfinished"):FireServer(unpack(args))
                    end
                end
            end)
        end
    end)
end

spawn(function()
    while task.wait(3) do
        pcall(function()
            if game.PlaceId == 16732694052 then
                --if game:GetService("Players").LocalPlayer.PlayerGui.loading.Enabled ~= true and not game.Workspace:FindFirstChild("active") and game.Workspace.active:FindFirstChild("flags")  then
                    if game:GetService("Players").LocalPlayer.PlayerGui.loading.Enabled == true then
                        game:GetService("VirtualInputManager"):SendMouseButtonEvent(10, 100, 0, true, nil, 1)
                        game:GetService("VirtualInputManager"):SendMouseButtonEvent(10, 100, 0, false, nil, 1)
                    end
                    if game.Workspace:FindFirstChild("active") and game.Workspace.active:FindFirstChild("flags") then
                        game.Workspace.active.flags:Destroy()
                    end
                --end
            end
        end)
    end
end)

spawn(function()
    while task.wait(0.1) do
        pcall(function()
            if game:GetService("Players").LocalPlayer.PlayerGui.loading.Enabled == false then
                ManagePlayerActions()
                Sell()
                AutoEquip()
                AutoEquip2()
                Autorobs()
                Reset()
            end
        end)
    end
end)
